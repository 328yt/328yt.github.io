<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tambola Game 6.2</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,1,0" />
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.5);
            --panel-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            
            --accent-blue: #007AFF;
            --accent-purple: #5856D6;
            --accent-pink: #FF2D55;
            --accent-gold: #FFD60A;
            --accent-green: #34C759;
            
            --bg-gradient: linear-gradient(135deg, #E0C3FC 0%, #8EC5FC 100%);
            --text-primary: #1d1d1f;
            --text-secondary: #424245;
            
            --grid-called-bg: var(--accent-blue);
            --grid-called-text: #fff;
            
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --roll-opacity: 0.3;
        }

        body.theme-dark {
            --glass-bg: rgba(30, 30, 30, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6;
            --grid-called-bg: var(--accent-purple);
            --panel-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        body.theme-royal {
            --glass-bg: rgba(60, 10, 80, 0.7);
            --glass-border: rgba(255, 215, 0, 0.3);
            --bg-gradient: radial-gradient(circle at center, #2E0249 0%, #570A57 100%);
            --text-primary: #fff;
            --text-secondary: #e0e0e0;
            --grid-called-bg: var(--accent-gold);
            --grid-called-text: #2E0249;
        }

        body.theme-nature {
            --bg-gradient: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%);
            --glass-bg: rgba(255, 255, 255, 0.9);
            --text-primary: #1a472a;
            --grid-called-bg: var(--accent-green);
        }

        body.theme-sunset {
            --bg-gradient: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
            --glass-bg: rgba(255, 230, 230, 0.9);
            --text-primary: #5d1a1a;
            --grid-called-bg: var(--accent-pink);
        }

        body.theme-ocean {
            --bg-gradient: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
            --glass-bg: rgba(240, 255, 255, 0.9);
            --text-primary: #0f3460;
            --grid-called-bg: #007AFF;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: var(--font-family);
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        .material-symbols-rounded { font-size: 24px; font-variation-settings: 'FILL' 1, 'wght' 600, 'GRAD' 0, 'opsz' 24; }

        /* --- Components --- */

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--panel-shadow);
        }

        .btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-bottom-width: 4px;
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.1s;
            display: inline-flex; align-items: center; justify-content: center;
            gap: 6px; font-size: 0.95rem;
            margin-bottom: 4px;
        }
        .btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
            margin-bottom: 6px;
        }
        .btn:hover { filter: brightness(1.1); }
        
        .btn-primary { 
            background: var(--accent-blue); 
            color: #fff; border-color: rgba(0,0,0,0.1); border-bottom-color: rgba(0,0,0,0.3); 
        }
        .theme-dark .btn-primary { background: #0A84FF; }
        .theme-royal .btn-primary { background: #FFD700; color: #2E0249; border-bottom-color: rgba(46, 2, 73, 0.4); }

        .btn-danger { background: #FF3B30; color: white; border-bottom-color: #c02a21; }

        .btn-icon { padding: 8px; border-radius: 50%; aspect-ratio: 1; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 8px; border-bottom-width: 3px; }

        /* --- Layout --- */

        header { 
            height: 60px; display: flex; justify-content: space-between; align-items: center; 
            padding: 0 20px; z-index: 20; 
            background: var(--glass-bg); backdrop-filter: blur(20px); 
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        #gameTitle { 
            font-size: 1.3rem; font-weight: 800; letter-spacing: -0.5px; opacity: 0.9;
            cursor: pointer; padding: 5px 10px; border-radius: 8px;
            border: 1px solid transparent; transition: all 0.2s;
        }
        #gameTitle:hover {
            background: rgba(0,0,0,0.05);
            border-color: var(--glass-border);
        }
        #gameTitle:after {
            content: 'edit'; font-family: 'Material Symbols Rounded'; 
            font-size: 16px; margin-left: 8px; opacity: 0; transition: opacity 0.2s; vertical-align: middle;
        }
        #gameTitle:hover:after { opacity: 0.5; }

        .action-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 20px; z-index: 10; height: 80px; gap: 20px;
        }

        .history-wrapper {
            flex: 1; display: flex; align-items: center; gap: 12px;
            background: var(--glass-bg); padding: 8px 16px; border-radius: 50px;
            border: 1px solid var(--glass-border); overflow: hidden;
            box-shadow: var(--panel-shadow);
        }
        .history-container { 
            display: flex; align-items: center; gap: 8px; overflow-x: auto; 
            scrollbar-width: none; mask-image: linear-gradient(to right, black 85%, transparent 100%);
            width: 100%;
        }
        .history-ball {
            width: 38px; height: 38px; border-radius: 50%; 
            background: rgba(120, 120, 120, 0.15);
            color: var(--text-primary); display: flex; align-items: center; justify-content: center; 
            font-weight: 700; font-size: 1rem; flex-shrink: 0;
        }
        .history-ball.latest {
            width: 44px; height: 44px; background: var(--accent-pink); 
            color: white; font-size: 1.3rem;
        }

        .main-container { 
            flex: 1; display: flex; padding: 0 20px 20px 20px; gap: 20px; 
            overflow: hidden; position: relative; 
        }

        .board-wrapper { 
            flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; 
            padding: 20px; 
            overflow: visible; /* Allows cells to pop out without clipping */
        }
        
        .number-grid {
            display: grid; 
            grid-template-columns: repeat(10, 1fr); 
            grid-template-rows: repeat(9, 1fr);
            gap: 6px; 
            width: 100%; 
            height: 100%; 
            aspect-ratio: 10/9; 
            max-height: 100%; 
            max-width: 100%; 
            margin: auto;
        }
        
        .cell {
            display: flex; align-items: center; justify-content: center; 
            background: rgba(120, 120, 120, 0.1);
            border-radius: 8px; font-weight: 700; 
            font-size: clamp(0.8rem, 2vw, 2rem); /* Slightly reduced for safety */
            color: var(--text-primary); opacity: 0.7;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: default;
            position: relative;
        }
        
        .cell.called { 
            background: var(--grid-called-bg); 
            color: var(--grid-called-text, #fff); 
            opacity: 1; 
            transform: scale(1.15) translateY(-2px); /* High impact pop */
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            font-weight: 800; 
            border: 2px solid rgba(255,255,255,0.4);
            z-index: 10;
        }
        
        .cell.last-called { 
            animation: pulse 1.5s infinite; 
            border: 3px solid #fff; 
            z-index: 15;
            box-shadow: 0 0 30px var(--accent-pink);
        }

        .prize-panel { 
            width: 350px; display: flex; flex-direction: column; 
            overflow: hidden; flex-shrink: 0;
            background: var(--glass-bg);
        }
        .prize-header { 
            padding: 15px 20px; font-weight: 800; font-size: 1.2rem;
            border-bottom: 1px solid var(--glass-border); 
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.02);
        }
        .prize-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .prize-item { 
            background: rgba(255,255,255,0.4); 
            border-radius: 12px; padding: 12px; 
            display: flex; flex-direction: column; gap: 6px; 
            border: 1px solid var(--glass-border);
            transition: transform 0.2s;
            position: relative;
        }
        .theme-dark .prize-item { background: rgba(255,255,255,0.05); }
        .prize-item:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .prize-item.claimed { opacity: 0.6; background: rgba(0,0,0,0.05); }
        .prize-item.claimed .prize-name { text-decoration: line-through; }
        
        .prize-row { display: flex; justify-content: space-between; align-items: center; }
        .prize-name { font-weight: 700; font-size: 1rem; color: var(--text-primary); }
        .prize-amt { 
            background: var(--grid-called-bg); color: #fff; 
            padding: 4px 10px; border-radius: 6px; font-size: 0.9rem; font-weight: 800;
        }
        .prize-winner { 
            font-size: 0.9rem; color: var(--accent-gold); font-weight: 700; 
            background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px;
            display: inline-block; margin-top: 4px;
        }

        /* --- Modals & Overlays --- */

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); 
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 2000; display: none; opacity: 0; transition: opacity 0.3s;
        }
        .modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95);
            width: 90%; max-width: 450px; background: var(--glass-bg); 
            border: 1px solid var(--glass-border);
            color: var(--text-primary); padding: 0; border-radius: 24px; z-index: 2100; 
            display: none; flex-direction: column;
            box-shadow: 0 40px 80px rgba(0,0,0,0.3); max-height: 85vh; 
            opacity: 0; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal.open { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.03); }
        .modal-title { font-size: 1.3rem; font-weight: 800; margin: 0; }
        .modal-body { padding: 24px; overflow-y: auto; }

        .settings-section { margin-bottom: 25px; }
        .settings-section-title { font-size: 0.85rem; font-weight: 800; text-transform: uppercase; color: var(--accent-blue); letter-spacing: 1px; margin-bottom: 12px; opacity: 0.9; }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; opacity: 0.8; }
        select, input {
            width: 100%; height: 48px; padding: 0 16px; 
            background: rgba(120, 120, 120, 0.1); border: 1px solid transparent;
            color: var(--text-primary); border-radius: 12px; font-size: 1rem;
            transition: 0.2s; font-family: inherit;
        }
        select:focus, input:focus { background: rgba(120, 120, 120, 0.05); border-color: var(--accent-blue); box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1); }

        /* Guide / Dummy Ticket */
        .guide-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; height: 400px; }
        .guide-list { overflow-y: auto; padding-right: 10px; border-right: 1px solid var(--glass-border); }
        .guide-item { padding: 12px; margin-bottom: 5px; border-radius: 10px; cursor: pointer; transition: 0.2s; font-weight: 600; font-size: 0.95rem; }
        .guide-item:hover { background: rgba(120,120,120,0.1); }
        .guide-item.active { background: var(--accent-blue); color: white; }
        
        .dummy-ticket { 
            display: grid; grid-template-columns: repeat(9, 1fr); gap: 4px; 
            background: #FFD700; padding: 6px; border-radius: 8px; width: 100%; align-self: center;
            border: 2px solid #e6c200;
        }
        .dt-cell { 
            aspect-ratio: 1; background: #fff; color: #333; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 800; font-size: 0.8rem; border-radius: 4px; 
        }
        .dt-cell.empty { background: rgba(255,255,255,0.4); }
        .dt-cell.pulsing { 
            background: #FF2D55; color: white; 
            animation: pulse 1s infinite; 
            box-shadow: 0 0 10px #FF2D55; z-index: 2; 
        }

        /* Roll Overlay & Animation */
        #rollOverlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, var(--roll-opacity));
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: 1800; display: none;
            flex-direction: column; align-items: center; justify-content: center; 
            opacity: 0; transition: opacity 0.3s;
        }
        .roll-circle {
            width: 280px; height: 280px; border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 0 50px rgba(0, 122, 255, 0.4);
            position: relative;
        }
        
        /* Inner Spinner */
        .roll-circle::after {
            content: ''; position: absolute; inset: -10px; border-radius: 50%;
            border: 6px solid transparent; 
            border-top-color: var(--accent-pink);
            border-right-color: var(--accent-blue);
            animation: spin 1s cubic-bezier(0.165, 0.84, 0.44, 1) infinite;
        }
        
        /* Outer Spinner */
        .roll-circle::before {
            content: ''; position: absolute; inset: -25px; border-radius: 50%;
            border: 4px solid transparent; 
            border-left-color: var(--accent-gold);
            border-bottom-color: var(--accent-green);
            opacity: 0.6;
            animation: spin 1.5s linear infinite reverse;
        }

        #bigNumber { 
            font-size: 11rem; font-weight: 900; color: var(--text-primary); 
            letter-spacing: -8px; text-shadow: 0 4px 30px rgba(0,0,0,0.2); 
            z-index: 2;
        }
        
        #rollStatus { 
            margin-top: 50px; font-size: 2rem; font-weight: 900; 
            letter-spacing: 6px; color: #fff; text-transform: uppercase;
            text-shadow: 0 4px 20px rgba(0,0,0,0.5); 
        }

        /* Banner */
        .banner { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); 
            width: 90%; max-width: 500px; text-align: center; z-index: 2500; 
            opacity: 0; pointer-events: none; transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 32px; padding: 40px; background: var(--glass-bg);
            border: 2px solid var(--accent-gold);
            box-shadow: 0 30px 90px rgba(0,0,0,0.5);
        }
        .banner.active { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 900px) {
            .main-container { flex-direction: column; padding: 15px; gap: 15px; overflow: hidden; }
            .action-bar { height: auto; flex-wrap: wrap; padding: 10px 15px; }
            .history-wrapper { order: 2; width: 100%; margin-top: 5px; }
            /* Extra padding on mobile to handle 1.15x scale pop */
            .board-wrapper { padding: 25px; overflow: visible; }
            .prize-panel { width: 100%; height: 40vh; flex: none; order: 3; }
            /* Adjusted aspect ratio to let grid breathe */
            .number-grid { aspect-ratio: unset; height: auto; width: 100%; }
            #rollBtn { width: 100%; padding: 14px; }
            .guide-grid { grid-template-columns: 1fr; height: auto; }
            .guide-list { height: 150px; border-right: none; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; margin-bottom: 10px; }
        }
    </style>
</head>
<body class="theme-glass">

    <!-- Overlays -->
    <div id="backdrop" class="modal-overlay"></div>

    <div id="rollOverlay">
        <div class="roll-circle"><div id="bigNumber">00</div></div>
        <div id="rollStatus">ROLLING</div>
    </div>

    <!-- Winner Banner -->
    <div id="winnerBanner" class="banner">
        <div style="font-size:5rem; margin-bottom:10px;">üèÜ</div>
        <h2 style="margin:0; font-weight:900; text-transform:uppercase; color:var(--accent-gold);">Congratulations!</h2>
        <div style="margin:20px 0; font-size:1.2rem; opacity:0.9;">The winner of</div>
        <div id="wbPrize" style="background:var(--accent-blue); color:white; padding:10px 30px; border-radius:50px; display:inline-block; font-weight:800; font-size:1.2rem; margin-bottom:20px;">PRIZE NAME</div>
        <div style="margin-bottom:10px; opacity:0.9;">is</div>
        <div id="wbName" style="font-size:3rem; font-weight:900; line-height:1.1; color:var(--text-primary);">Winner Name</div>
        <button class="btn btn-primary" style="margin-top:40px; width:100%; font-size:1.2rem; padding:15px;" onclick="ui.closeOverlays()">Celebrate!</button>
    </div>

    <!-- Credits Banner -->
    <div id="creditsBanner" class="banner">
        <div style="font-size:3rem; margin-bottom:15px;">‚ù§Ô∏è</div>
        <h2 style="font-weight:900;">Credits</h2>
        <div style="margin:20px 0;">
            <div style="font-size:0.9rem; text-transform:uppercase; letter-spacing:1px; opacity:0.6;">Developed By</div>
            <div style="font-size:2.5rem; font-weight:900; background: linear-gradient(90deg, #007AFF, #FF2D55); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Banga</div>
        </div>
        <p style="opacity:0.8;">Ultimate Party Tambola<br>Version 6.2</p>
        <button class="btn" style="margin-top:20px; width:100%;" onclick="ui.closeOverlays()">Close</button>
    </div>

    <!-- Header -->
    <header>
        <div style="display:flex; align-items:center; gap:8px;">
            <div id="gameTitle" onclick="game.editTitle()">Tambola Night</div>
            <button class="btn btn-icon" onclick="game.toggleAudio()" id="audioBtn" title="Sound">
                <span class="material-symbols-rounded">volume_up</span>
            </button>
        </div>
        <div style="display:flex; gap:8px;">
            <button class="btn btn-icon" onclick="ui.openCredits()" title="Credits">
                <span class="material-symbols-rounded">info</span>
            </button>
            <button class="btn btn-icon" style="background:var(--accent-gold); color:#000; border-color:rgba(0,0,0,0.1);" onclick="ui.openGuide()" title="How to Play">
                <span class="material-symbols-rounded">help</span>
            </button>
            <button class="btn btn-icon" id="autoBtn" onclick="game.toggleAutoplay()" title="Autoplay">
                <span class="material-symbols-rounded">play_circle</span>
            </button>
            <button class="btn btn-icon" onclick="ui.openModal('settingsModal')" title="Settings">
                <span class="material-symbols-rounded">settings</span>
            </button>
        </div>
    </header>

    <!-- Action Bar -->
    <div class="action-bar">
        <div class="history-wrapper">
            <span class="material-symbols-rounded" style="font-size:20px; opacity:0.5;">history</span>
            <div class="history-container" id="historyList"></div>
        </div>
        <div style="display:flex; gap:10px; flex-shrink:0;">
            <button class="btn" onclick="game.confirmReset()">
                <span class="material-symbols-rounded">refresh</span> New Game
            </button>
            <button id="rollBtn" class="btn btn-primary" style="padding: 10px 30px; font-size:1.1rem;" onclick="game.rollDice()">
                <span class="material-symbols-rounded">casino</span> ROLL
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        <div class="board-wrapper glass-panel">
            <div class="number-grid" id="grid"></div>
        </div>
        <div class="prize-panel glass-panel">
            <div class="prize-header">
                <span>Prizes</span>
                <button class="btn btn-sm btn-primary" onclick="ui.openModal('addPrizeModal')">
                    <span class="material-symbols-rounded" style="font-size:18px">add</span> Add
                </button>
            </div>
            <div class="prize-list" id="prizeList"></div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal" style="max-width: 350px;">
        <div class="modal-header" style="border-bottom:none; padding-bottom:0;">
            <button class="btn btn-icon" style="margin-left:auto;" onclick="ui.closeModal('deleteConfirmModal')"><span class="material-symbols-rounded">close</span></button>
        </div>
        <div class="modal-body" style="text-align:center; padding-top:0;">
            <span class="material-symbols-rounded" style="font-size:48px; color:#FF3B30; margin-bottom:15px;">delete</span>
            <h3 style="margin:0 0 10px 0;">Delete Prize?</h3>
            <p style="opacity:0.7; margin-bottom:25px;">Are you sure you want to remove this prize? This action cannot be undone.</p>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1" onclick="ui.closeModal('deleteConfirmModal')">Cancel</button>
                <button class="btn btn-danger" style="flex:1" onclick="game.confirmDeletePrize()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Claim Modal -->
    <div id="claimModal" class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Claim Prize</h3>
            <button class="btn btn-icon" onclick="ui.closeModal('claimModal')"><span class="material-symbols-rounded">close</span></button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Prize</label>
                <input type="text" id="claimPrizeName" disabled style="opacity:0.7">
            </div>
            <div class="form-group">
                <label class="form-label">Winner Name</label>
                <input type="text" id="claimWinnerName" placeholder="Enter name...">
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="game.submitClaim()">Confirm Win</button>
        </div>
    </div>

    <!-- Edit Prize Modal -->
    <div id="editPrizeModal" class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Edit Prize</h3>
            <button class="btn btn-icon" onclick="ui.closeModal('editPrizeModal')"><span class="material-symbols-rounded">close</span></button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Prize Name</label>
                <input type="text" id="editPrizeName">
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" id="editPrizeAmount">
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="game.submitEditPrize()">Save Changes</button>
        </div>
    </div>

    <!-- Add Prize Modal -->
    <div id="addPrizeModal" class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Add New Prize</h3>
            <button class="btn btn-icon" onclick="ui.closeModal('addPrizeModal')"><span class="material-symbols-rounded">close</span></button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Prize Name</label>
                <input type="text" id="addPrizeName" placeholder="e.g. Early 7">
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" id="addPrizeAmount" value="100">
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="game.submitAddPrize()">Add Prize</button>
        </div>
    </div>

    <!-- Guide Modal -->
    <div id="guideModal" class="modal" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">Winning Patterns</h3>
            <button class="btn btn-icon" onclick="ui.closeModal('guideModal')"><span class="material-symbols-rounded">close</span></button>
        </div>
        <div class="modal-body">
            <div class="guide-grid">
                <div class="guide-list" id="guideList">
                    <!-- Populated by JS -->
                </div>
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <div class="dummy-ticket" id="dummyTicket">
                        <!-- Populated by JS -->
                    </div>
                    <div id="guideDesc" style="margin-top:20px; text-align:center; font-weight:600; opacity:0.8;">Select a pattern to see details.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Settings</h3>
            <button class="btn btn-icon" onclick="ui.closeModal('settingsModal')"><span class="material-symbols-rounded">close</span></button>
        </div>
        <div class="modal-body">
            <!-- Visuals Section -->
            <div class="settings-section">
                <div class="settings-section-title">Visuals</div>
                <div class="form-group">
                    <label class="form-label">Theme</label>
                    <select id="themeSelect" onchange="game.setTheme(this.value)">
                        <option value="theme-glass">Glass Light</option>
                        <option value="theme-dark">Midnight Dark</option>
                        <option value="theme-royal">Royal Purple</option>
                        <option value="theme-nature">Nature Green</option>
                        <option value="theme-sunset">Sunset Orange</option>
                        <option value="theme-ocean">Ocean Teal</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Roll Overlay Opacity</label>
                    <input type="range" id="opacityRange" min="0.1" max="1" step="0.1" onchange="game.updateSettings()">
                </div>
            </div>

            <!-- Audio Section -->
            <div class="settings-section">
                <div class="settings-section-title">Audio & Voice</div>
                <div class="form-group">
                    <label class="form-label">Voice (TTS)</label>
                    <select id="voiceSelect" onchange="game.setVoice(this.value)">
                        <option value="default">Default Browser Voice</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Phrase Style</label>
                    <select id="phraseSelect" onchange="game.setPhraseGroup(this.value)">
                        <option value="english">Classic English</option>
                        <option value="hindi">Hindi</option>
                        <option value="bollywood">Bollywood</option>
                    </select>
                </div>
            </div>

            <!-- Gameplay Section -->
            <div class="settings-section" style="margin-bottom:0;">
                <div class="settings-section-title">Gameplay</div>
                <div class="form-group">
                    <label class="form-label">Roll Speed</label>
                    <input type="range" id="speedRange" min="1000" max="5000" step="100" onchange="game.updateSettings()">
                </div>
            </div>
        </div>
    </div>

    <canvas id="confetti" style="position:fixed; top:0; left:0; pointer-events:none; z-index:1800;"></canvas>

    <script>
        const defaultPhrases = {
            english: [null, "Kelly's Eye", "One Little Duck", "Cup of Tea", "Knock at the Door", "Man Alive", "Tom Mix", "Lucky Seven", "Garden Gate", "Doctor's Orders", "Boris's Den", "Legs Eleven", "One Dozen", "Unlucky for Some", "Valentine's Day", "Young and Keen", "Sweet Sixteen", "Dancing Queen", "Coming of Age", "Goodbye Teens", "One Score", "Key of the Door", "Two Little Ducks", "Thee and Me", "Two Dozen", "Duck and Dive", "Pick and Mix", "Gateway to Heaven", "In a State", "Rise and Shine", "Dirty Gertie", "Get Up and Run", "Buckle My Shoe", "All the Threes", "Ask for More", "Jump and Jive", "Three Dozen", "More than Eleven", "Christmas Cake", "Steps", "Life Begins", "Time for Fun", "Winnie the Pooh", "Down on Your Knees", "Droopy Drawers", "Halfway There", "Up to Tricks", "Four and Seven", "Four Dozen", "PC", "Half a Century", "Tweak of the Thumb", "Danny La Rue", "Stuck in the Tree", "Clean the Floor", "Snakes Alive", "Shotts Bus", "Heinz Varieties", "Make Them Wait", "Brighton Line", "Five Dozen", "Baker's Bun", "Turn the Screw", "Tickle Me 63", "Red Raw", "Old Age Pension", "Clickety Click", "Made in Heaven", "Saving Grace", "Any Way Up", "Three Score and Ten", "Bang on the Drum", "Six Dozen", "Queen Bee", "Hit the Floor", "Strive and Strive", "Trombones", "Sunset Strip", "39 More Steps", "One More Time", "Eight and Blank", "Stop and Run", "Straight on Through", "Time for Tea", "Seven Dozen", "Staying Alive", "Between the Sticks", "Torquay in Devon", "Two Fat Ladies", "Nearly There", "Top of the Shop"],
            hindi: [null, "Ek Dum", "Do number ka kaam", "Teen Tigada", "Chaar yaar", "Hum Paanch", "Innings ki pehli ball", "Saath nibhana", "Thaath", "Nav Grah", "Bus Number", "Ek aur ek gyarah", "Bara baje", "Tera mera", "Bachhon ka din", "Azadi", "Solah baras ki", "Satra khatra", "Thaat", "Unni", "Ek score", "Shagun", "Do Hanso ka joda", "Teis", "Chaubis", "Chandi", "Chabbis", "Satais", "Uthais", "Unatees", "Tees", "Ikattees", "Battis", "Tetees", "Chautis", "Paintis", "Chattis ka aankda", "Sainthis", "Adthis", "Untalis", "Alibaba Chalis Chor", "Ek aur Chalis", "Bharat Chodo", "Taintalis", "Chauvalis", "Pentalis", "Chiyalis", "Senthalis", "Adthalis", "Unchas", "Ardha Shatak", "Ikavan", "Bavan", "Tirpan", "Chauvan", "Pachpan Bachpan", "Chappan", "Satavan", "Athavan", "Unsath", "Saath", "Iksath", "Basath", "Tirsath", "Chausath", "Pensath", "Chachhat", "Sadsath", "Adsath", "Ulta Pulta", "Sattar", "Ikhattar", "Bahattar", "Tihattar", "Chauhattar", "Pichhattar", "Chihattar", "Thanda Sata-satt", "Athhattar", "Unnasi", "Assi", "Ikyasi", "Byasi", "Tirasi", "Chaurasi", "Pachasi", "Chiyasi", "Sattaasi", "Moti Aunties", "Navasi", "Nanna Munna Rahi"],
            bollywood: [null, "Don ko pakadna mushkil hi nahi...", "Do Dil Mil Rahe Hain", "3 Idiots", "Krazzy 4", "Hum Paanch", "Dilli 6", "Saat Samundar Paar", "Aathvaan Ajooba", "Number 9", "Dus Numbri", "Ek Aur Ek Gyarah", "Barah Aana", "Tera Mera Saath Rahen", "Chaudhvin Ka Chand", "15th August", "Solah Baras Ki", "Satra Pe Khatra", "Athara Baras Ki", "1947 Earth", "Bees Saal Baad", "Table No 21", "Do Hanso Ka Joda", "23rd March 1931", "24 Ghante", "Pachhis (Karan Arjun)", "Special 26", "Twenty Seven Down", "Kudi da weight 28", "Umar hai 29", "Tees Maar Khan", "Aankh Marey", "Battis Gul", "Radha Teri Chunari", "Dil Mange More", "Jaane Jaan Dhoondhta", "36 China Town", "Mere Sapno Ki Rani", "Do Lafzon Ki Hai", "Tumhi Ho Bandhu", "Ali Baba 40 Chor", "Ektaalis", "Shri 420", "Mein Rang Sharbaton Ka", "Lungi Dance", "Aaj Blue Hain Paani", "Tum Hi Ho", "AK-47", "Balam Pichkari", "Dilli Wali Girl Friend", "Pachaas", "Shubh Number", "Baavan Pattey", "Tirangaa", "Chor Machaye Shor", "Pachpan", "Ab Tak Chhappan", "Mangal Pandey", "Time to Retire", "Unsath", "Saath", "Iksath", "Basath", "Tirsath", "64 Squares", "Aamir Khan Born", "Chakke Pe Chakka", "Akshay Kumar Born", "Vaada Raha Pyaar Se", "Ulta Pulta", "Sattar Minute", "Border (1971)", "72 Hoorain", "Tihattar", "Chauhattar", "Sholay Released", "Abhishek Bachchan Born", "Hum Saath Saath Hain", "Khiladi 786", "Unnasi", "Assi Tassi", "8x10 Tasveer", "Byasi", "83 The Movie", "Punjab 1984", "Pachasi", "Chiyasi", "Sattaasi", "Qayamat Se Qayamat Tak", "Navasi", "Band Baaja Baraat"]
        };

        const defaultPrizes = [
            { id:1, name:"Early 5", amount:100 },
            { id:2, name:"Top Line", amount:100 },
            { id:3, name:"Middle Line", amount:100 },
            { id:4, name:"Bottom Line", amount:100 },
            { id:5, name:"Corners", amount:100 },
            { id:6, name:"Full House", amount:200 },
            { id:7, name:"Temperature", amount:100 },
            { id:8, name:"Jawaani", amount:100 },
            { id:9, name:"Budhapa", amount:100 },
            { id:10, name:"Pyramid", amount:100 },
            { id:11, name:"Star", amount:100 },
            { id:12, name:"Bamboo", amount:100 },
            { id:13, name:"King's Corner", amount:100 },
            { id:14, name:"Queen's Corner", amount:100 },
            { id:15, name:"Breakfast", amount:100 },
            { id:16, name:"Lunch", amount:100 },
            { id:17, name:"Dinner", amount:100 }
        ];

        const guidePatterns = {
            'Early 5': "First 5 numbers matched anywhere.",
            'Top Line': "All numbers in the top row (1st line).",
            'Middle Line': "All numbers in the middle row (2nd line).",
            'Bottom Line': "All numbers in the bottom row (3rd line).",
            'Corners': "First and last numbers of top and bottom rows.",
            'Full House': "All 15 numbers on the ticket.",
            'Temperature': "Smallest (min) and Largest (max) numbers.",
            'Jawaani': "All numbers from 1 to 49.",
            'Budhapa': "All numbers from 50 to 90.",
            'Pyramid': "Top: Center, Mid: 2 & 4, Bot: 1, 3, 5 (Visual Pyramid).",
            'Star': "4 Corners + Exact center of the ticket.",
            'Bamboo': "The middle (3rd) number of every row.",
            'King\'s Corner': "Last number of every row.",
            'Queen\'s Corner': "First number of every row.",
            'Breakfast': "Columns 1, 2, 3 (Vertical Block 1).",
            'Lunch': "Columns 4, 5, 6 (Vertical Block 2).",
            'Dinner': "Columns 7, 8, 9 (Vertical Block 3)."
        };

        /** Audio System **/
        const AudioSys = {
            ctx: null,
            init: function() {
                if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                if(this.ctx.state === 'suspended') this.ctx.resume();
            },
            playTick: function() {
                if(!game.audioEnabled) return;
                this.init();
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.connect(g); g.connect(this.ctx.destination);
                o.type = 'triangle'; // Sharp click
                o.frequency.setValueAtTime(1200, this.ctx.currentTime);
                g.gain.setValueAtTime(0.3, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.05); // Short decay
                o.start(); o.stop(this.ctx.currentTime + 0.05);
            },
            playFinalTick: function() {
                if(!game.audioEnabled) return;
                this.init();
                // Heavier "Thud" or "Tock"
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.connect(g); g.connect(this.ctx.destination);
                o.type = 'square';
                o.frequency.setValueAtTime(400, this.ctx.currentTime);
                o.frequency.exponentialRampToValueAtTime(50, this.ctx.currentTime + 0.1); // Pitch drop
                g.gain.setValueAtTime(0.2, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                o.start(); o.stop(this.ctx.currentTime + 0.1);
            },
            playTrumpet: function() {
                if(!game.audioEnabled) return;
                this.init();
                // Fanfare: C4, C4, C4, G4 (Triple tongue + Long)
                const now = this.ctx.currentTime;
                const notes = [
                    { f: 523.25, s: 0, d: 0.1 },     // C4
                    { f: 523.25, s: 0.15, d: 0.1 },  // C4
                    { f: 523.25, s: 0.3, d: 0.1 },   // C4
                    { f: 783.99, s: 0.45, d: 0.8 }   // G4 (Long)
                ];

                notes.forEach(n => {
                    const o = this.ctx.createOscillator();
                    const g = this.ctx.createGain();
                    o.type = 'sawtooth'; // Trumpet-like timbre
                    
                    // Low pass filter to soften the harsh sawtooth
                    const filter = this.ctx.createBiquadFilter();
                    filter.type = "lowpass";
                    filter.frequency.value = 2000;

                    o.connect(filter);
                    filter.connect(g);
                    g.connect(this.ctx.destination);

                    o.frequency.value = n.f;
                    
                    // ADSR Envelope
                    g.gain.setValueAtTime(0, now + n.s);
                    g.gain.linearRampToValueAtTime(0.15, now + n.s + 0.05); // Attack
                    g.gain.linearRampToValueAtTime(0.1, now + n.s + n.d - 0.05); // Decay/Sustain
                    g.gain.linearRampToValueAtTime(0, now + n.s + n.d); // Release

                    o.start(now + n.s);
                    o.stop(now + n.s + n.d + 0.1);
                });
            }
        };

        class TambolaGame {
            constructor() {
                this.state = JSON.parse(localStorage.getItem('tambola_v6_2')) || {
                    called: [], history: [], 
                    prizes: JSON.parse(JSON.stringify(defaultPrizes)),
                    settings: { 
                        theme: 'theme-glass', 
                        speed: 2500, 
                        phraseGroup: 'english', 
                        rollOpacity: 0.3,
                        voiceURI: null
                    },
                    title: "Tambola Night"
                };
                this.isRolling = false;
                this.isAutoplay = false;
                this.audioEnabled = true;
                this.timer = null;
                this.activePrizeId = null; 
                this.activeDeleteId = null;
                this.voices = [];
                this.selectedVoiceURI = this.state.settings.voiceURI;
                this.init();
            }

            init() {
                this.setTheme(this.state.settings.theme);
                this.setRollOpacity(this.state.settings.rollOpacity);
                this.renderGrid();
                this.renderHistory();
                this.renderPrizes();
                
                document.getElementById('gameTitle').innerText = this.state.title || "Tambola Night";
                document.getElementById('themeSelect').value = this.state.settings.theme;
                document.getElementById('phraseSelect').value = this.state.settings.phraseGroup;
                document.getElementById('speedRange').value = this.state.settings.speed;
                document.getElementById('opacityRange').value = this.state.settings.rollOpacity || 0.3;

                const populateVoices = () => {
                    this.voices = window.speechSynthesis.getVoices();
                    const select = document.getElementById('voiceSelect');
                    if(select) {
                        select.innerHTML = '<option value="default">Default Browser Voice</option>';
                        this.voices.forEach(v => {
                            const opt = document.createElement('option');
                            opt.value = v.voiceURI;
                            opt.text = `${v.name} (${v.lang})`;
                            select.appendChild(opt);
                        });
                        if (this.state.settings.voiceURI) {
                             select.value = this.state.settings.voiceURI;
                        }
                    }
                };
                
                window.speechSynthesis.onvoiceschanged = populateVoices;
                populateVoices(); 
            }

            save() { localStorage.setItem('tambola_v6_2', JSON.stringify(this.state)); }

            setVoice(v) { 
                this.selectedVoiceURI = v; 
                this.state.settings.voiceURI = v;
                this.save();
                
                if(this.audioEnabled) {
                    const u = new SpeechSynthesisUtterance("Test Voice");
                    if(v !== 'default') {
                         const voiceObj = this.voices.find(voice => voice.voiceURI === v);
                         if(voiceObj) u.voice = voiceObj;
                    }
                    window.speechSynthesis.speak(u);
                }
            }

            editTitle() {
                const newTitle = prompt("Enter Game Title:", this.state.title);
                if(newTitle && newTitle.trim() !== "") {
                    this.state.title = newTitle.trim();
                    document.getElementById('gameTitle').innerText = this.state.title;
                    this.save();
                }
            }

            toggleAudio() {
                this.audioEnabled = !this.audioEnabled;
                document.getElementById('audioBtn').querySelector('span').innerText = this.audioEnabled ? 'volume_up' : 'volume_off';
                if(this.audioEnabled) AudioSys.init();
            }

            toggleAutoplay() {
                this.isAutoplay = !this.isAutoplay;
                const icon = document.getElementById('autoBtn').querySelector('span');
                icon.innerText = this.isAutoplay ? 'pause_circle' : 'play_circle';
                if(this.isAutoplay) this.loopAutoplay();
                else clearTimeout(this.timer);
            }

            loopAutoplay() {
                if(!this.isAutoplay || this.state.called.length >= 90) return;
                this.rollDice();
            }

            rollDice() {
                if(this.isRolling || this.state.called.length >= 90) return;
                this.isRolling = true;
                AudioSys.init(); 
                
                const overlay = document.getElementById('rollOverlay');
                const bigNum = document.getElementById('bigNumber');
                
                overlay.style.display = 'flex';
                setTimeout(()=>overlay.style.opacity = '1', 10);
                
                // No blur class added

                const interval = setInterval(() => {
                    bigNum.innerText = Math.floor(Math.random() * 90) + 1;
                    AudioSys.playTick(); // Mechanical Tick
                }, 60);

                setTimeout(() => {
                    clearInterval(interval);
                    this.finalizeRoll(overlay, bigNum);
                }, parseInt(this.state.settings.speed));
            }

            finalizeRoll(overlay, bigNum) {
                let num;
                do { num = Math.floor(Math.random() * 90) + 1; } while (this.state.called.includes(num));
                
                this.state.called.push(num);
                this.state.history.unshift(num);
                if(this.state.history.length > 20) this.state.history.pop();
                this.save();

                bigNum.innerText = num;
                document.getElementById('rollStatus').innerText = "NUMBER OUT!";
                
                AudioSys.playFinalTick(); // Replaced with solid ending tick

                setTimeout(() => {
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        document.getElementById('rollStatus').innerText = "ROLLING";
                        this.isRolling = false;
                        
                        this.renderGrid();
                        this.renderHistory();
                        this.announce(num);
                        
                        const cell = document.getElementById(`cell-${num}`);
                        if(cell) cell.scrollIntoView({behavior: "smooth", block: "center"});

                        if(this.isAutoplay) this.timer = setTimeout(() => this.loopAutoplay(), 3000);
                    }, 300);
                }, 1500);
            }

            announce(num) {
                if(!this.audioEnabled) return;
                const group = this.state.settings.phraseGroup;
                const phrases = defaultPhrases[group];
                const phrase = phrases[num] ? phrases[num] : "";
                const text = phrase ? `${phrase}, Number ${num}` : `Number ${num}`;
                
                const u = new SpeechSynthesisUtterance(text);
                if(this.selectedVoiceURI && this.selectedVoiceURI !== 'default') {
                    const voiceObj = this.voices.find(v => v.voiceURI === this.selectedVoiceURI);
                    if(voiceObj) u.voice = voiceObj;
                }
                u.rate = 0.9;
                window.speechSynthesis.speak(u);
            }

            renderGrid() {
                const grid = document.getElementById('grid');
                grid.innerHTML = '';
                const last = this.state.history[0];
                for(let i=1; i<=90; i++) {
                    const div = document.createElement('div');
                    div.className = 'cell';
                    div.id = `cell-${i}`;
                    div.innerText = i;
                    if(this.state.called.includes(i)) div.classList.add('called');
                    if(i === last) div.classList.add('last-called');
                    grid.appendChild(div);
                }
            }

            renderHistory() {
                const list = document.getElementById('historyList');
                list.innerHTML = '';
                this.state.history.forEach((n, i) => {
                    const b = document.createElement('div');
                    b.className = `history-ball ${i===0?'latest':''}`;
                    b.innerText = n;
                    list.appendChild(b);
                });
            }

            renderPrizes() {
                const list = document.getElementById('prizeList');
                list.innerHTML = '';
                this.state.prizes.forEach((p, i) => {
                    const div = document.createElement('div');
                    div.className = `prize-item ${p.claimed ? 'claimed' : ''}`;
                    div.innerHTML = `
                        <div class="prize-row">
                            <span class="prize-name">${p.name}</span>
                            <span class="prize-amt">‚Çπ${p.amount}</span>
                        </div>
                        ${p.winner ? `<div class="prize-winner">üèÜ ${p.winner}</div>` : ''}
                        <div class="prize-row" style="margin-top:10px; border-top:1px solid rgba(0,0,0,0.05); padding-top:8px;">
                            <div style="display:flex; gap:6px;">
                                <button class="btn btn-sm btn-primary" onclick="ui.openClaimModal(${i})">${p.claimed ? 'Re-Claim' : 'Claim'}</button>
                                <button class="btn btn-sm" onclick="ui.openEditPrizeModal(${i})">
                                    <span class="material-symbols-rounded" style="font-size:16px">edit</span>
                                </button>
                            </div>
                            <button class="btn btn-icon btn-sm btn-danger" style="padding:4px; border-radius:8px;" onclick="game.initDeletePrize(${i})">
                                <span class="material-symbols-rounded" style="font-size:16px">delete</span>
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }

            setTheme(t) {
                document.body.className = t;
                this.state.settings.theme = t;
                this.save();
            }

            setRollOpacity(v) { document.documentElement.style.setProperty('--roll-opacity', v); }
            setPhraseGroup(g) { this.state.settings.phraseGroup = g; this.save(); }
            updateSettings() {
                this.state.settings.speed = document.getElementById('speedRange').value;
                this.state.settings.rollOpacity = document.getElementById('opacityRange').value;
                this.setRollOpacity(this.state.settings.rollOpacity);
                this.save();
            }

            confirmReset() {
                if(confirm("Start a new game?")) {
                    this.state.called = [];
                    this.state.history = [];
                    this.state.prizes.forEach(p => { p.claimed = false; p.winner = null; });
                    this.save();
                    location.reload();
                }
            }

            initDeletePrize(i) {
                this.activeDeleteId = i;
                ui.openModal('deleteConfirmModal');
            }

            confirmDeletePrize() {
                if(this.activeDeleteId !== null) {
                    this.state.prizes.splice(this.activeDeleteId, 1);
                    this.save();
                    this.renderPrizes();
                    ui.closeModal('deleteConfirmModal');
                    this.activeDeleteId = null;
                }
            }

            submitAddPrize() {
                const name = document.getElementById('addPrizeName').value;
                const amt = document.getElementById('addPrizeAmount').value;
                if(name && amt) {
                    this.state.prizes.push({ id: Date.now(), name, amount: amt, claimed: false });
                    this.save();
                    this.renderPrizes();
                    ui.closeModal('addPrizeModal');
                }
            }

            submitClaim() {
                const name = document.getElementById('claimWinnerName').value;
                if(this.activePrizeId !== null && name) {
                    const p = this.state.prizes[this.activePrizeId];
                    p.claimed = true;
                    p.winner = name;
                    this.save();
                    this.renderPrizes();
                    ui.closeModal('claimModal');
                    ui.showWinner(p.name, name);
                    AudioSys.playTrumpet(); 
                }
            }

            submitEditPrize() {
                const name = document.getElementById('editPrizeName').value;
                const amt = document.getElementById('editPrizeAmount').value;
                if(this.activePrizeId !== null && name && amt) {
                    const p = this.state.prizes[this.activePrizeId];
                    p.name = name;
                    p.amount = amt;
                    this.save();
                    this.renderPrizes();
                    ui.closeModal('editPrizeModal');
                }
            }
        }

        const game = new TambolaGame();

        /** UI Controller **/
        const ui = {
            backdrop: document.getElementById('backdrop'),
            openModal: function(id) {
                this.backdrop.style.display = 'block';
                setTimeout(()=>this.backdrop.style.opacity='1', 10);
                const m = document.getElementById(id);
                m.style.display = 'flex';
                setTimeout(()=>m.classList.add('open'), 10);
            },
            closeModal: function(id) {
                const m = document.getElementById(id);
                m.classList.remove('open');
                setTimeout(()=>{
                    m.style.display = 'none';
                    if(!document.querySelector('.banner.active') && !document.querySelector('.modal.open')) this.closeOverlays();
                }, 300);
            },
            openClaimModal: function(idx) {
                game.activePrizeId = idx;
                const p = game.state.prizes[idx];
                document.getElementById('claimPrizeName').value = p.name;
                document.getElementById('claimWinnerName').value = p.winner || "";
                this.openModal('claimModal');
                document.getElementById('claimWinnerName').focus();
            },
            openEditPrizeModal: function(idx) {
                game.activePrizeId = idx;
                const p = game.state.prizes[idx];
                document.getElementById('editPrizeName').value = p.name;
                document.getElementById('editPrizeAmount').value = p.amount;
                this.openModal('editPrizeModal');
            },
            showWinner: function(prize, name) {
                document.getElementById('wbPrize').innerText = prize;
                document.getElementById('wbName').innerText = name;
                this.backdrop.style.display = 'block';
                setTimeout(()=>this.backdrop.style.opacity='1', 10);
                document.getElementById('winnerBanner').classList.add('active');
                startConfetti();
            },
            openCredits: function() {
                this.backdrop.style.display = 'block';
                setTimeout(()=>this.backdrop.style.opacity='1', 10);
                document.getElementById('creditsBanner').classList.add('active');
            },
            openGuide: function() {
                const list = document.getElementById('guideList');
                list.innerHTML = '';
                Object.keys(guidePatterns).forEach(key => {
                    const div = document.createElement('div');
                    div.className = 'guide-item';
                    div.innerText = key;
                    div.onclick = () => this.showGuidePattern(key, div);
                    list.appendChild(div);
                });
                this.showGuidePattern('Early 5', list.firstChild);
                this.openModal('guideModal');
            },
            showGuidePattern: function(type, el) {
                document.querySelectorAll('.guide-item').forEach(d => d.classList.remove('active'));
                if(el) el.classList.add('active');
                document.getElementById('guideDesc').innerText = guidePatterns[type];
                
                // Draw Dummy Ticket
                const ticket = document.getElementById('dummyTicket');
                ticket.innerHTML = '';
                const gridData = [
                    [1,0,1,0,1,0,1,1,0],
                    [0,1,0,1,1,1,0,0,1],
                    [1,1,1,0,0,0,1,0,1]
                ];
                let cells = [];
                for(let r=0; r<3; r++) {
                    for(let c=0; c<9; c++) {
                        const d = document.createElement('div');
                        d.className = gridData[r][c] ? 'dt-cell' : 'dt-cell empty';
                        d.dataset.r = r; d.dataset.c = c;
                        if(gridData[r][c]) {
                            d.innerText = c*10 + r + 2; 
                            d.dataset.val = parseInt(d.innerText);
                            cells.push(d);
                        }
                        ticket.appendChild(d);
                    }
                }

                const rows = [[],[],[]];
                cells.forEach(cell => rows[cell.dataset.r].push(cell));

                if(type === 'Early 5') for(let i=0; i<5; i++) cells[i].classList.add('pulsing');
                if(type === 'Top Line') rows[0].forEach(c => c.classList.add('pulsing'));
                if(type === 'Middle Line') rows[1].forEach(c => c.classList.add('pulsing'));
                if(type === 'Bottom Line') rows[2].forEach(c => c.classList.add('pulsing'));
                if(type === 'Full House') cells.forEach(c => c.classList.add('pulsing'));
                if(type === 'Corners') {
                    rows[0][0].classList.add('pulsing'); rows[0][rows[0].length-1].classList.add('pulsing');
                    rows[2][0].classList.add('pulsing'); rows[2][rows[2].length-1].classList.add('pulsing');
                }
                if(type === 'Star') {
                    rows[0][0].classList.add('pulsing'); rows[0][rows[0].length-1].classList.add('pulsing');
                    rows[2][0].classList.add('pulsing'); rows[2][rows[2].length-1].classList.add('pulsing');
                    rows[1][2].classList.add('pulsing'); 
                }
                if(type === 'Pyramid') {
                     rows[0][2].classList.add('pulsing');
                     rows[1][1].classList.add('pulsing'); rows[1][3].classList.add('pulsing');
                     rows[2][0].classList.add('pulsing'); rows[2][2].classList.add('pulsing'); rows[2][4].classList.add('pulsing');
                }
                if(type === 'Breakfast') cells.filter(c => c.dataset.c < 3).forEach(c => c.classList.add('pulsing'));
                if(type === 'Lunch') cells.filter(c => c.dataset.c >= 3 && c.dataset.c < 6).forEach(c => c.classList.add('pulsing'));
                if(type === 'Dinner') cells.filter(c => c.dataset.c >= 6).forEach(c => c.classList.add('pulsing'));
                if(type === 'Temperature') { cells[0].classList.add('pulsing'); cells[cells.length-1].classList.add('pulsing'); }
                if(type === 'Bamboo') { rows[0][2].classList.add('pulsing'); rows[1][2].classList.add('pulsing'); rows[2][2].classList.add('pulsing'); }
                if(type === "King's Corner") [0,1,2].forEach(r => rows[r][rows[r].length-1].classList.add('pulsing'));
                if(type === "Queen's Corner") [0,1,2].forEach(r => rows[r][0].classList.add('pulsing'));
                if(type === 'Jawaani' || type === 'Budhapa') cells.forEach(c => c.classList.add('pulsing'));
            },
            closeOverlays: function() {
                this.backdrop.style.opacity = '0';
                document.querySelectorAll('.banner').forEach(b => b.classList.remove('active'));
                stopConfetti();
                setTimeout(()=>this.backdrop.style.display='none', 300);
            }
        };

        /** Confetti **/
        let confettiActive = false;
        const canvas = document.getElementById('confetti');
        const ctx = canvas.getContext('2d');
        let particles = [];

        function startConfetti() { confettiActive = true; loopConfetti(); }
        function stopConfetti() { confettiActive = false; particles = []; ctx.clearRect(0,0,canvas.width,canvas.height); }

        function loopConfetti() {
            if (!confettiActive && particles.length === 0) return;
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (confettiActive && particles.length < 150) {
                particles.push({
                    x: Math.random() * canvas.width, y: -10,
                    w: Math.random() * 10 + 5, h: Math.random() * 10 + 5,
                    dx: Math.random() * 4 - 2, dy: Math.random() * 5 + 2,
                    color: `hsl(${Math.random()*360}, 100%, 50%)`
                });
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, i) => {
                p.y += p.dy; p.x += p.dx;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.w, p.h);
                if (p.y > canvas.height) particles.splice(i, 1);
            });
            requestAnimationFrame(loopConfetti);
        }
    </script>
</body>
</html>
